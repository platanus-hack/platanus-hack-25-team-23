"use client"

import { useState, useEffect, useCallback, useMemo } from 'react'
import { useSearchParams } from 'next/navigation'
import { useKnowledge } from "@/lib/store/knowledge-context"
import { useJournal, JournalEntry, formatDate } from "@/lib/store/journal-context"
import { createClient } from "@/lib/supabase/client"
import {
  FolderOpen,
  FileText,
  Download,
  Sparkles,
  ChevronRight,
  ChevronDown,
  Brain,
  Clock,
  Zap,
  Plus,
  Settings,
  Pencil,
  Trash2,
  X,
  BookHeart,
  Calendar,
  Search
} from "lucide-react"
import { DEFAULT_AREAS, DEFAULT_YOU_NODE_COLOR, COLOR_PALETTE, AreaConfig, detectAreaFromContent } from '@/lib/data/areas-config'
import { useAreas } from '@/lib/store/areas-context'
import Link from 'next/link'
import { toast } from 'sonner'

interface LibraryNote {
  id: string
  title: string
  slug: string
  content: string
  status: 'new' | 'read' | 'understood'
  area: string
  areaColor: string
  createdAt: string
  lastModified: string
  wordCount: number
  conceptsCount: number
}

interface Folder {
  id: string
  name: string
  description: string
  color: string
  icon: string
  notes: LibraryNote[]
  subfolders?: Folder[]
  autoGenerated: boolean
  lastOrganized: Date
}

// Build AREA_CONFIG from shared DEFAULT_AREAS
const AREA_CONFIG: Record<string, { color: string; icon: string; description: string }> = {
  ...DEFAULT_AREAS.reduce((acc, area) => {
    acc[area.name] = { color: area.color, icon: area.icon, description: area.description }
    return acc
  }, {} as Record<string, { color: string; icon: string; description: string }>),
  'General': { color: '#C9B7F3', icon: 'üìù', description: 'Notas generales y temas variados' },
}

// Helper to categorize notes by keywords - using shared config
function detectArea(title: string, content: string): string {
  const detectedArea = detectAreaFromContent(title, content)
  return detectedArea ? detectedArea.name : 'General'
}

function getAreaConfig(areaName: string) {
  return AREA_CONFIG[areaName] || AREA_CONFIG['General']
}

// Helper functions moved outside component for better performance and to avoid hoisting issues
function getStatusLabel(status: string) {
  switch (status) {
    case 'understood': return '‚úÖ Entendido'
    case 'read': return 'üîÑ En progreso'
    case 'new': return '‚è≥ Pendiente'
    default: return status
  }
}

function getStatusStyle(status: string) {
  switch (status) {
    case 'understood':
      return { background: 'linear-gradient(135deg, #A3E4B6 0%, #B9E2B1 100%)', color: '#2F8F4F' }
    case 'read':
      return { background: 'linear-gradient(135deg, #FFE9A9 0%, #FFF4D4 100%)', color: '#B89C3C' }
    case 'new':
      return { background: 'linear-gradient(135deg, #FFB1B1 0%, #FFCBCB 100%)', color: '#CC5050' }
    default:
      return { background: '#F6F6F6', color: '#646464' }
  }
}

function getTimeSince(dateString: string, now: number) {
  const hours = Math.floor((now - new Date(dateString).getTime()) / (1000 * 60 * 60))
  if (hours < 1) return 'hace menos de 1h'
  if (hours < 24) return `hace ${hours}h`
  const days = Math.floor(hours / 24)
  if (days === 1) return 'hace 1 d√≠a'
  return `hace ${days} d√≠as`
}

function getHoursSince(date: Date, now: number) {
  return Math.floor((now - date.getTime()) / (1000 * 60 * 60))
}

export default function LibraryPage() {
  const { notes: contextNotes, session } = useKnowledge()
  const { entries: journalEntries } = useJournal()
  const { areas, youNodeColor, setYouNodeColor, updateArea, deleteArea, addArea } = useAreas()
  const searchParams = useSearchParams()
  const [libraryNotes, setLibraryNotes] = useState<LibraryNote[]>([])
  const [loading, setLoading] = useState(true)
  const [isOrganizing, setIsOrganizing] = useState(false)
  const [lastOrganized, setLastOrganized] = useState(new Date())
  const [expandedFolders, setExpandedFolders] = useState<Set<string>>(new Set())
  const [showAreaManager, setShowAreaManager] = useState(false)
  const [customColor, setCustomColor] = useState('#6366f1')
  const [searchQuery, setSearchQuery] = useState('')

  // Sync search query with URL params
  useEffect(() => {
    const urlSearch = searchParams.get('search')
    if (urlSearch) {
      setSearchQuery(urlSearch)
    }
  }, [searchParams])

  // Edit modal state
  const [editingArea, setEditingArea] = useState<AreaConfig | null>(null)
  const [editName, setEditName] = useState('')
  const [editDescription, setEditDescription] = useState('')
  const [editColor, setEditColor] = useState('')
  const [editIcon, setEditIcon] = useState('')

  // Delete confirmation state
  const [deletingArea, setDeletingArea] = useState<AreaConfig | null>(null)

  // New area state
  const [showNewAreaForm, setShowNewAreaForm] = useState(false)
  const [newAreaName, setNewAreaName] = useState('')
  const [newAreaDescription, setNewAreaDescription] = useState('')
  const [newAreaColor, setNewAreaColor] = useState('#6366f1')
  const [newAreaIcon, setNewAreaIcon] = useState('üìÅ')

  // Load library data on mount and when session/notes change
  useEffect(() => {
    let mounted = true

    async function loadData() {
      // If no session, use notes from context
      if (!session?.user) {
        const notesFromContext: LibraryNote[] = contextNotes.map(note => {
          const area = detectArea(note.title, note.content)
          return {
            id: note.id || note.slug,
            title: note.title,
            slug: note.slug,
            content: note.content,
            status: note.status,
            area,
            areaColor: getAreaConfig(area).color,
            createdAt: new Date().toISOString(),
            lastModified: new Date().toISOString(),
            wordCount: note.content.split(/\s+/).length,
            conceptsCount: Math.floor(note.content.split(/\s+/).length / 50) + 1
          }
        })
        if (mounted) {
          setLibraryNotes(notesFromContext)
          if (notesFromContext.length > 0) {
            const firstArea = detectArea(notesFromContext[0].title, notesFromContext[0].content)
            setExpandedFolders(new Set([firstArea.toLowerCase().replace(/\s+/g, '-')]))
          }
          setLoading(false)
        }
        return
      }

      const supabase = createClient()
      const { data: notesData, error } = await supabase
        .from('notes')
        .select('*')
        .eq('user_id', session.user.id)
        .order('created_at', { ascending: false })

      if (!mounted) return

      if (error) {
        console.error('Error loading notes:', error)
        toast.error('Error al cargar las notas')
        setLoading(false)
        return
      }

      if (notesData) {
        const loadedNotes: LibraryNote[] = notesData.map(n => {
          const area = detectArea(n.title, n.content || '')
          return {
            id: n.id,
            title: n.title,
            slug: n.slug,
            content: n.content || '',
            status: (n.status || 'new') as 'new' | 'read' | 'understood',
            area,
            areaColor: getAreaConfig(area).color,
            createdAt: n.created_at,
            lastModified: n.updated_at || n.created_at,
            wordCount: (n.content || '').split(/\s+/).length,
            conceptsCount: Math.floor((n.content || '').split(/\s+/).length / 50) + 1
          }
        })
        setLibraryNotes(loadedNotes)
        if (loadedNotes.length > 0) {
          setExpandedFolders(new Set([loadedNotes[0].area.toLowerCase().replace(/\s+/g, '-')]))
        }
      }
      setLoading(false)
    }

    loadData()
    return () => { mounted = false }
  }, [session, contextNotes])

  // Calculate stats
  const stats = useMemo(() => {
    const total = libraryNotes.length
    const understood = libraryNotes.filter(n => n.status === 'understood').length
    const inProgress = libraryNotes.filter(n => n.status === 'read').length
    const pending = libraryNotes.filter(n => n.status === 'new').length
    return { total, understood, inProgress, pending }
  }, [libraryNotes])

  // Filter notes by search query
  const filteredNotes = useMemo(() => {
    if (!searchQuery.trim()) return libraryNotes
    const query = searchQuery.toLowerCase()
    return libraryNotes.filter(note =>
      note.title.toLowerCase().includes(query) ||
      note.content.toLowerCase().includes(query)
    )
  }, [libraryNotes, searchQuery])

  // Create folder structure from context areas (synced with Gestionar √Åreas)
  const folders: Folder[] = useMemo(() => {
    // Group notes by area name
    const grouped = filteredNotes.reduce((acc, note) => {
      if (!acc[note.area]) {
        acc[note.area] = []
      }
      acc[note.area].push(note)
      return acc
    }, {} as Record<string, LibraryNote[]>)

    // Create folders from ALL areas in context (synced with area manager)
    // Notes without a detected area will be assigned to the first area
    const contextFolders = areas.map(area => ({
      id: area.id,
      name: area.name,
      description: area.description,
      color: area.color,
      icon: area.icon,
      notes: grouped[area.name] || [],
      autoGenerated: true,
      lastOrganized
    }))

    // Assign unclassified notes (General) to first area if exists
    const contextAreaNames = new Set(areas.map(a => a.name))
    const unclassifiedNotes = Object.entries(grouped)
      .filter(([areaName]) => !contextAreaNames.has(areaName))
      .flatMap(([, notes]) => notes)

    if (unclassifiedNotes.length > 0 && contextFolders.length > 0) {
      contextFolders[0].notes = [...contextFolders[0].notes, ...unclassifiedNotes]
    }

    return contextFolders
  }, [filteredNotes, lastOrganized, areas])

  // Filter journal entries by search query
  const filteredJournalEntries = useMemo(() => {
    if (!searchQuery.trim()) return journalEntries
    const query = searchQuery.toLowerCase()
    return journalEntries.filter(entry => {
      const entryText = [
        entry.pilesAffirmation,
        entry.freeThoughts,
        entry.daily_intention,
        entry.lesson,
        ...(entry.gratitude || []),
        ...(entry.best_moments || []),
        ...(entry.make_great || []),
        ...(entry.pilesItems?.map(i => i.text) || [])
      ].filter(Boolean).join(' ').toLowerCase()
      return entryText.includes(query) || entry.date.includes(query)
    })
  }, [journalEntries, searchQuery])

  // Group journal entries by year > month > entries (hierarchical structure like Calendar > 2025 > 09 > 2025-09-12)
  const journalHierarchy = useMemo(() => {
    const hierarchy: Record<string, Record<string, JournalEntry[]>> = {}
    filteredJournalEntries.forEach(entry => {
      const year = entry.date.substring(0, 4) // YYYY
      const month = entry.date.substring(5, 7) // MM
      if (!hierarchy[year]) {
        hierarchy[year] = {}
      }
      if (!hierarchy[year][month]) {
        hierarchy[year][month] = []
      }
      hierarchy[year][month].push(entry)
    })
    // Sort entries within each month by date descending
    Object.keys(hierarchy).forEach(year => {
      Object.keys(hierarchy[year]).forEach(month => {
        hierarchy[year][month].sort((a, b) => b.date.localeCompare(a.date))
      })
    })
    return hierarchy
  }, [filteredJournalEntries])

  // Filter folders to hide empty ones when searching
  const displayFolders = useMemo(() => {
    if (!searchQuery.trim()) return folders
    return folders.filter(folder => folder.notes.length > 0)
  }, [folders, searchQuery])

  // Toggle folder expansion
  const toggleFolder = (folderId: string) => {
    setExpandedFolders(prev => {
      const newSet = new Set(prev)
      if (newSet.has(folderId)) {
        newSet.delete(folderId)
      } else {
        newSet.add(folderId)
      }
      return newSet
    })
  }

  // Reorganize handler
  const handleReorganize = useCallback(async () => {
    setIsOrganizing(true)
    // Simulate reorganization
    await new Promise(resolve => setTimeout(resolve, 2000))

    // Re-detect areas for all notes
    const reorganized = libraryNotes.map(note => {
      const area = detectArea(note.title, note.content)
      return {
        ...note,
        area,
        areaColor: getAreaConfig(area).color
      }
    })

    setLibraryNotes(reorganized)
    setLastOrganized(new Date())
    setIsOrganizing(false)
    toast.success(`Reorganizado! ${reorganized.length} notas en ${new Set(reorganized.map(n => n.area)).size} carpetas`)
  }, [libraryNotes])

  // Export folder to Markdown
  const exportFolderToMarkdown = useCallback((folder: Folder) => {
    let markdown = `# ${folder.icon} ${folder.name}\n\n`
    markdown += `> ${folder.description}\n\n`
    markdown += `**√öltima organizaci√≥n:** ${folder.lastOrganized.toLocaleString('es')}\n\n`
    markdown += `---\n\n`

    folder.notes.forEach(note => {
      markdown += `## ${note.title}\n\n`
      markdown += `- **Estado:** ${getStatusLabel(note.status)}\n`
      markdown += `- **Creado:** ${new Date(note.createdAt).toLocaleDateString('es')}\n`
      markdown += `- **Palabras:** ${note.wordCount}\n`
      markdown += `- **Conceptos:** ${note.conceptsCount}\n\n`
      markdown += `${note.content}\n\n`
      markdown += `---\n\n`
    })

    const blob = new Blob([markdown], { type: 'text/markdown' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `${folder.name.toLowerCase().replace(/\s+/g, '-')}.md`
    document.body.appendChild(a)
    a.click()
    document.body.removeChild(a)
    URL.revokeObjectURL(url)

    toast.success('Exportado correctamente')
  }, [])

  // Edit area handlers
  const handleStartEdit = useCallback((area: AreaConfig) => {
    setEditingArea(area)
    setEditName(area.name)
    setEditDescription(area.description)
    setEditColor(area.color)
    setEditIcon(area.icon)
  }, [])

  const handleSaveEdit = useCallback(() => {
    if (!editingArea) return
    if (!editName.trim()) {
      toast.error('El nombre es requerido')
      return
    }
    updateArea(editingArea.id, {
      name: editName.trim(),
      description: editDescription.trim(),
      color: editColor,
      icon: editIcon
    })
    setEditingArea(null)
    toast.success('√Årea actualizada correctamente')
  }, [editingArea, editName, editDescription, editColor, editIcon, updateArea])

  const handleCancelEdit = useCallback(() => {
    setEditingArea(null)
    setEditName('')
    setEditDescription('')
    setEditColor('')
    setEditIcon('')
  }, [])

  // Delete area handlers
  const handleConfirmDelete = useCallback(() => {
    if (!deletingArea) return
    deleteArea(deletingArea.id)
    setDeletingArea(null)
    toast.success('√Årea eliminada correctamente')
  }, [deletingArea, deleteArea])

  // New area handlers
  const handleAddNewArea = useCallback(() => {
    if (!newAreaName.trim()) {
      toast.error('El nombre es requerido')
      return
    }
    const newArea: AreaConfig = {
      id: newAreaName.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, ''),
      name: newAreaName.trim(),
      description: newAreaDescription.trim() || 'Nueva √°rea tem√°tica',
      icon: newAreaIcon,
      color: newAreaColor,
      colorVariants: [],
      keywords: []
    }
    addArea(newArea)
    setShowNewAreaForm(false)
    setNewAreaName('')
    setNewAreaDescription('')
    setNewAreaColor('#6366f1')
    setNewAreaIcon('üìÅ')
    toast.success('Nueva √°rea creada correctamente')
  }, [newAreaName, newAreaDescription, newAreaIcon, newAreaColor, addArea])

  // Current time state for time-based calculations (updated on mount)
  const [currentTime, setCurrentTime] = useState(() => Date.now())

  useEffect(() => {
    // Update time every minute for "time since" calculations
    const interval = setInterval(() => setCurrentTime(Date.now()), 60000)
    return () => clearInterval(interval)
  }, [])

  // Render folder component - Clean Style
  const renderFolder = (folder: Folder) => {
    const isExpanded = expandedFolders.has(folder.id)
    const totalNotes = folder.notes.length

    return (
      <div key={folder.id} className="mb-3">
        {/* Folder Header - Clean Style */}
        <div
          className="p-4 rounded-2xl cursor-pointer transition-all hover:shadow-md"
          style={{
            backgroundColor: 'white',
            boxShadow: '0px 2px 8px rgba(0, 0, 0, 0.04)'
          }}
          onClick={() => toggleFolder(folder.id)}
        >
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3 flex-1">
              <button style={{ color: '#9A9A9A' }}>
                {isExpanded ? (
                  <ChevronDown className="size-5" />
                ) : (
                  <ChevronRight className="size-5" />
                )}
              </button>

              <div
                className="w-10 h-10 rounded-xl flex items-center justify-center"
                style={{ backgroundColor: `${folder.color}20` }}
              >
                <span className="text-xl">{folder.icon}</span>
              </div>

              <div className="flex-1">
                <div className="flex items-center gap-2">
                  <h3 className="font-semibold" style={{ color: '#222222' }}>
                    {folder.name}
                  </h3>
                  <span
                    className="text-xs px-2 py-0.5 rounded-full"
                    style={{ backgroundColor: '#F6F5F2', color: '#6D6D6D' }}
                  >
                    {totalNotes}
                  </span>
                </div>
                <p className="text-xs" style={{ color: '#9A9A9A' }}>
                  {folder.description}
                </p>
              </div>
            </div>

            <button
              onClick={(e) => {
                e.stopPropagation()
                exportFolderToMarkdown(folder)
              }}
              className="px-3 py-1.5 rounded-lg text-xs font-medium transition-all hover:opacity-80"
              style={{ backgroundColor: '#F6F5F2', color: '#6D6D6D' }}
            >
              <Download className="size-3.5 inline mr-1" />
              Exportar
            </button>
          </div>
        </div>

        {/* Folder Contents - Clean Style */}
        {isExpanded && (
          <div className="ml-8 mt-2 space-y-2">
            {folder.notes.map(note => (
              <Link
                key={note.id}
                href={`/study?topic=${encodeURIComponent(note.title)}`}
                className="block p-3 rounded-xl hover:shadow-md transition-all"
                style={{
                  backgroundColor: 'white',
                  boxShadow: '0px 2px 8px rgba(0, 0, 0, 0.04)'
                }}
              >
                <div className="flex items-center gap-3">
                  <div
                    className="w-8 h-8 rounded-lg flex items-center justify-center"
                    style={{ backgroundColor: '#E6DAFF' }}
                  >
                    <FileText className="size-4" style={{ color: '#9575CD' }} />
                  </div>
                  <div className="flex-1">
                    <div className="flex items-center gap-2">
                      <h4 className="font-medium text-sm" style={{ color: '#222222' }}>
                        {note.title}
                      </h4>
                      <span
                        className="text-xs px-2 py-0.5 rounded-full"
                        style={{
                          backgroundColor: note.status === 'understood' ? '#D4F5E9' : note.status === 'read' ? '#FFF0E6' : '#FFD9D9',
                          color: note.status === 'understood' ? '#10B981' : note.status === 'read' ? '#F5A962' : '#E57373'
                        }}
                      >
                        {note.status === 'understood' ? '‚úì Entendido' : note.status === 'read' ? '‚óã En progreso' : '‚óã Pendiente'}
                      </span>
                    </div>
                    <div className="flex items-center gap-3 text-xs mt-1" style={{ color: '#9A9A9A' }}>
                      <span>{note.wordCount} palabras</span>
                      <span>‚Ä¢</span>
                      <span>{getTimeSince(note.lastModified, currentTime)}</span>
                    </div>
                  </div>
                </div>
              </Link>
            ))}
          </div>
        )}
      </div>
    )
  }

  if (loading) {
    return (
      <div className="flex-1 flex items-center justify-center transition-colors duration-300" style={{ backgroundColor: 'var(--background)' }}>
        <div className="text-center">
          <div className="w-12 h-12 border-4 border-purple-300 rounded-full animate-spin mx-auto mb-4" style={{ borderTopColor: '#C9B7F3' }} />
          <p style={{ color: 'var(--muted-foreground)' }}>Cargando biblioteca...</p>
        </div>
      </div>
    )
  }

  return (
    <div className="flex-1 overflow-y-auto transition-colors duration-300" style={{ backgroundColor: 'var(--background)' }}>
      <div className="max-w-6xl mx-auto px-8 py-8">
        {/* Header - Clean Style */}
        <div className="mb-8">
          <div className="flex items-center justify-between mb-6">
            <div>
              <h1 className="text-3xl font-bold mb-1 flex items-center gap-3" style={{ color: '#222222' }}>
                <FolderOpen className="size-8" style={{ color: '#9575CD' }} />
                Biblioteca
              </h1>
              <p className="text-sm" style={{ color: '#6D6D6D' }}>
                Tus notas organizadas autom√°ticamente por la IA
              </p>
            </div>

            <div className="flex items-center gap-3">
              <button
                onClick={() => setShowAreaManager(!showAreaManager)}
                className="px-4 py-2.5 rounded-xl transition-all flex items-center gap-2 hover:opacity-90 font-medium"
                style={{
                  backgroundColor: showAreaManager ? '#CFE4FF' : 'white',
                  color: showAreaManager ? '#5A8FCC' : '#6D6D6D',
                  boxShadow: '0px 2px 8px rgba(0, 0, 0, 0.04)'
                }}
              >
                <Settings className="size-4" />
                Gestionar √Åreas
              </button>
              <button
                onClick={handleReorganize}
                disabled={isOrganizing}
                className="px-4 py-2.5 rounded-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 hover:opacity-90 font-medium"
                style={{
                  backgroundColor: '#FFD9D9',
                  color: '#222222'
                }}
              >
                {isOrganizing ? (
                  <>
                    <div
                      className="w-4 h-4 border-2 border-current rounded-full animate-spin"
                      style={{ borderTopColor: 'transparent' }}
                    />
                    Reorganizando...
                  </>
                ) : (
                  <>
                    <Zap className="size-4" />
                    Reorganizar
                  </>
                )}
              </button>
            </div>
          </div>

          {/* Search Bar */}
          <div className="mb-6">
            <div className="relative max-w-md">
              <Search
                className="absolute left-4 top-1/2 transform -translate-y-1/2 size-5"
                style={{ color: '#9A9A9A' }}
              />
              <input
                type="text"
                placeholder="Buscar en biblioteca..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="w-full pl-12 pr-10 py-3 rounded-xl text-sm transition-all focus:outline-none focus:ring-2"
                style={{
                  backgroundColor: 'white',
                  border: '1px solid #EEEBE6',
                  color: '#222222',
                  boxShadow: '0px 2px 8px rgba(0, 0, 0, 0.04)'
                }}
              />
              {searchQuery && (
                <button
                  onClick={() => setSearchQuery('')}
                  className="absolute right-4 top-1/2 transform -translate-y-1/2 hover:opacity-70"
                >
                  <X className="size-4" style={{ color: '#9A9A9A' }} />
                </button>
              )}
            </div>
            {searchQuery && (
              <p className="mt-2 text-sm" style={{ color: '#6D6D6D' }}>
                {filteredNotes.length + filteredJournalEntries.length} resultado{(filteredNotes.length + filteredJournalEntries.length) !== 1 ? 's' : ''} para "{searchQuery}"
                {filteredNotes.length > 0 && ` (${filteredNotes.length} notas`}
                {filteredNotes.length > 0 && filteredJournalEntries.length > 0 && ', '}
                {filteredJournalEntries.length > 0 && `${filteredJournalEntries.length} journal)`}
                {filteredNotes.length > 0 && filteredJournalEntries.length === 0 && ')'}
              </p>
            )}
          </div>

          {/* Stats - Clean Style */}
          <div className="grid grid-cols-4 gap-4 mb-6">
            <div
              className="p-4 rounded-2xl hover:shadow-md transition-all"
              style={{ backgroundColor: 'white', boxShadow: '0px 2px 8px rgba(0, 0, 0, 0.04)' }}
            >
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-xl flex items-center justify-center" style={{ backgroundColor: '#E6DAFF' }}>
                  <FileText className="size-5" style={{ color: '#9575CD' }} />
                </div>
                <div>
                  <div className="text-2xl font-bold" style={{ color: '#222222' }}>{stats.total}</div>
                  <div className="text-xs" style={{ color: '#6D6D6D' }}>Notas totales</div>
                </div>
              </div>
            </div>
            <div
              className="p-4 rounded-2xl hover:shadow-md transition-all"
              style={{ backgroundColor: 'white', boxShadow: '0px 2px 8px rgba(0, 0, 0, 0.04)' }}
            >
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-xl flex items-center justify-center" style={{ backgroundColor: '#D4F5E9' }}>
                  <Brain className="size-5" style={{ color: '#10B981' }} />
                </div>
                <div>
                  <div className="text-2xl font-bold" style={{ color: '#222222' }}>{stats.understood}</div>
                  <div className="text-xs" style={{ color: '#6D6D6D' }}>Entendidas</div>
                </div>
              </div>
            </div>
            <div
              className="p-4 rounded-2xl hover:shadow-md transition-all"
              style={{ backgroundColor: 'white', boxShadow: '0px 2px 8px rgba(0, 0, 0, 0.04)' }}
            >
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-xl flex items-center justify-center" style={{ backgroundColor: '#FFF0E6' }}>
                  <Clock className="size-5" style={{ color: '#F5A962' }} />
                </div>
                <div>
                  <div className="text-2xl font-bold" style={{ color: '#222222' }}>{stats.inProgress}</div>
                  <div className="text-xs" style={{ color: '#6D6D6D' }}>En progreso</div>
                </div>
              </div>
            </div>
            <div
              className="p-4 rounded-2xl hover:shadow-md transition-all"
              style={{ backgroundColor: 'white', boxShadow: '0px 2px 8px rgba(0, 0, 0, 0.04)' }}
            >
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-xl flex items-center justify-center" style={{ backgroundColor: '#FFD9D9' }}>
                  <FileText className="size-5" style={{ color: '#E57373' }} />
                </div>
                <div>
                  <div className="text-2xl font-bold" style={{ color: '#222222' }}>{stats.pending}</div>
                  <div className="text-xs" style={{ color: '#6D6D6D' }}>Pendientes</div>
                </div>
              </div>
            </div>
          </div>

          {/* Info Banner - Clean Style */}
          <div
            className="p-4 rounded-2xl flex items-center gap-4"
            style={{
              backgroundColor: '#FFF0E6',
              boxShadow: '0px 2px 8px rgba(0, 0, 0, 0.04)'
            }}
          >
            <div
              className="w-10 h-10 rounded-xl flex items-center justify-center"
              style={{ backgroundColor: 'white' }}
            >
              <Sparkles className="size-5" style={{ color: '#F5A962' }} />
            </div>
            <div className="flex-1">
              <p className="text-sm" style={{ color: '#222222' }}>
                <span className="font-medium">Organizaci√≥n Autom√°tica:</span>{' '}
                <span style={{ color: '#6D6D6D' }}>
                  √öltima reorganizaci√≥n hace {getHoursSince(lastOrganized, currentTime)} horas
                </span>
              </p>
            </div>
          </div>
        </div>

        {/* Folders */}
        <div className="space-y-4">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-lg font-medium" style={{ color: 'var(--foreground)' }}>
              Carpetas organizadas por la IA
            </h2>
            <button
              onClick={() => setShowAreaManager(!showAreaManager)}
              className="px-4 py-2 rounded-2xl transition-all flex items-center gap-2 hover:scale-105 duration-300 font-medium"
              style={{
                backgroundColor: 'var(--card)',
                color: 'var(--muted-foreground)',
                boxShadow: '0px 2px 8px rgba(0, 0, 0, 0.06)'
              }}
            >
              <Settings className="size-4" />
              {showAreaManager ? 'Ocultar' : 'Gestionar √Åreas y Colores'}
            </button>
          </div>

          {/* Area Management Panel */}
          {showAreaManager && (
            <div
              className="p-6 rounded-3xl mb-6"
              style={{
                backgroundColor: 'var(--card)',
                border: '2px solid #E6E6E6',
                boxShadow: '0px 4px 14px rgba(0, 0, 0, 0.06)'
              }}
            >
              <div className="flex items-center justify-between mb-6">
                <div className="flex items-center gap-3">
                  <span className="text-2xl">üß†</span>
                  <div>
                    <h3 className="font-bold text-lg" style={{ color: 'var(--foreground)' }}>
                      Gesti√≥n de √Åreas y Colores
                    </h3>
                    <p className="text-sm" style={{ color: 'var(--muted-foreground)' }}>
                      Personaliza los colores de cada √°rea tem√°tica para el grafo
                    </p>
                  </div>
                </div>
                <button
                  onClick={() => setShowNewAreaForm(true)}
                  className="px-5 py-2.5 rounded-2xl font-medium transition-all hover:scale-105"
                  style={{
                    background: 'linear-gradient(135deg, #C9B7F3 0%, #D6C9F5 100%)',
                    color: 'white',
                    boxShadow: '0px 2px 8px rgba(201, 183, 243, 0.3)'
                  }}
                >
                  <Plus className="size-4 inline mr-2" />
                  Nueva √Årea
                </button>
              </div>

              {/* Central Node "Yo" */}
              <div className="mb-6">
                <h4 className="text-sm font-semibold mb-3 flex items-center gap-2" style={{ color: 'var(--foreground)' }}>
                  üß† Nodo Central &quot;Yo&quot;
                </h4>
                <div
                  className="p-5 rounded-2xl"
                  style={{
                    backgroundColor: '#FAFBFC',
                    border: '2px solid #E6E6E6'
                  }}
                >
                  <div className="flex items-start gap-4">
                    <div
                      className="w-14 h-14 rounded-full flex items-center justify-center text-2xl"
                      style={{ backgroundColor: youNodeColor }}
                    >
                      üß†
                    </div>
                    <div className="flex-1">
                      <h5 className="font-semibold mb-1" style={{ color: 'var(--foreground)' }}>Nodo Central</h5>
                      <p className="text-sm mb-4" style={{ color: 'var(--muted-foreground)' }}>
                        Este es el nodo central de tu grafo. Todas las √°reas se conectan a este nodo.
                      </p>

                      <p className="text-xs font-medium mb-2" style={{ color: 'var(--muted-foreground)' }}>
                        Color del Nodo &quot;Yo&quot;
                      </p>
                      <div className="flex items-center gap-2 flex-wrap mb-3">
                        {COLOR_PALETTE.map((color) => (
                          <button
                            key={color}
                            onClick={() => setYouNodeColor(color)}
                            className="w-10 h-10 rounded-xl transition-all hover:scale-110"
                            style={{
                              backgroundColor: color,
                              border: youNodeColor === color ? '3px solid #1E1E1E' : '2px solid transparent',
                              boxShadow: youNodeColor === color ? '0px 2px 8px rgba(0, 0, 0, 0.2)' : 'none'
                            }}
                          >
                            {youNodeColor === color && (
                              <span className="text-white text-lg">‚úì</span>
                            )}
                          </button>
                        ))}
                      </div>

                      <div className="flex items-center gap-2">
                        <span className="text-xs" style={{ color: 'var(--muted-foreground)' }}>
                          O elige un color personalizado:
                        </span>
                        <input
                          type="color"
                          value={customColor}
                          onChange={(e) => {
                            setCustomColor(e.target.value)
                            setYouNodeColor(e.target.value)
                          }}
                          className="w-10 h-10 rounded-lg cursor-pointer border-2 border-gray-200"
                        />
                        <span className="text-xs font-mono" style={{ color: 'var(--muted-foreground)' }}>
                          {customColor}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Divider */}
              <div className="border-t mb-6" style={{ borderColor: '#E6E6E6' }} />

              {/* Areas List */}
              <h4 className="text-sm font-semibold mb-4" style={{ color: 'var(--foreground)' }}>
                √Åreas Tem√°ticas
              </h4>
              <div className="space-y-3">
                {areas.map((area) => (
                  <div
                    key={area.id}
                    className="p-4 rounded-2xl flex items-center justify-between"
                    style={{
                      backgroundColor: `${area.color}10`,
                      border: `2px solid ${area.color}40`
                    }}
                  >
                    <div className="flex items-center gap-4">
                      <span className="text-2xl">{area.icon}</span>
                      <div>
                        <h5 className="font-semibold" style={{ color: 'var(--foreground)' }}>
                          {area.name}
                        </h5>
                        <p className="text-sm" style={{ color: 'var(--muted-foreground)' }}>
                          {area.description}
                        </p>
                        <div className="flex items-center gap-2 mt-2">
                          <span className="text-xs" style={{ color: 'var(--muted-foreground)' }}>
                            Variantes:
                          </span>
                          {area.colorVariants.map((variant, idx) => (
                            <div
                              key={idx}
                              className="w-6 h-6 rounded-lg"
                              style={{ backgroundColor: variant }}
                              title={idx === 0 ? '√Årea' : idx === 1 ? 'Tema' : idx === 2 ? 'Subtema' : 'Notas'}
                            />
                          ))}
                        </div>
                      </div>
                    </div>
                    <div className="flex items-center gap-2">
                      <button
                        onClick={() => handleStartEdit(area)}
                        className="p-2.5 rounded-xl hover:scale-110 transition-all"
                        style={{
                          backgroundColor: 'var(--card)',
                          border: '1px solid #E6E6E6'
                        }}
                      >
                        <Pencil className="size-4" style={{ color: 'var(--muted-foreground)' }} />
                      </button>
                      <button
                        onClick={() => setDeletingArea(area)}
                        className="p-2.5 rounded-xl hover:scale-110 transition-all"
                        style={{
                          backgroundColor: 'var(--card)',
                          border: '1px solid #FFB1B1'
                        }}
                      >
                        <Trash2 className="size-4" style={{ color: '#CC5050' }} />
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Edit Area Modal */}
          {editingArea && (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
              <div
                className="w-full max-w-lg p-6 rounded-3xl"
                style={{ backgroundColor: 'var(--card)' }}
              >
                <div className="flex items-center justify-between mb-6">
                  <h3 className="text-xl font-bold" style={{ color: 'var(--foreground)' }}>
                    Editar √Årea
                  </h3>
                  <button
                    onClick={handleCancelEdit}
                    className="p-2 rounded-xl hover:bg-gray-100 transition-all"
                  >
                    <X className="size-5" style={{ color: 'var(--muted-foreground)' }} />
                  </button>
                </div>

                <div className="space-y-4">
                  <div>
                    <label className="text-sm font-medium mb-2 block" style={{ color: 'var(--foreground)' }}>
                      Icono
                    </label>
                    <input
                      type="text"
                      value={editIcon}
                      onChange={(e) => setEditIcon(e.target.value)}
                      className="w-20 p-3 rounded-xl text-2xl text-center"
                      style={{ backgroundColor: '#F6F6F6', border: '2px solid #E6E6E6' }}
                      maxLength={2}
                    />
                  </div>

                  <div>
                    <label className="text-sm font-medium mb-2 block" style={{ color: 'var(--foreground)' }}>
                      Nombre
                    </label>
                    <input
                      type="text"
                      value={editName}
                      onChange={(e) => setEditName(e.target.value)}
                      className="w-full p-3 rounded-xl"
                      style={{ backgroundColor: '#F6F6F6', border: '2px solid #E6E6E6', color: 'var(--foreground)' }}
                    />
                  </div>

                  <div>
                    <label className="text-sm font-medium mb-2 block" style={{ color: 'var(--foreground)' }}>
                      Descripci√≥n
                    </label>
                    <input
                      type="text"
                      value={editDescription}
                      onChange={(e) => setEditDescription(e.target.value)}
                      className="w-full p-3 rounded-xl"
                      style={{ backgroundColor: '#F6F6F6', border: '2px solid #E6E6E6', color: 'var(--foreground)' }}
                    />
                  </div>

                  <div>
                    <label className="text-sm font-medium mb-2 block" style={{ color: 'var(--foreground)' }}>
                      Color
                    </label>
                    <div className="flex items-center gap-2 flex-wrap">
                      {COLOR_PALETTE.map((color) => (
                        <button
                          key={color}
                          onClick={() => setEditColor(color)}
                          className="w-10 h-10 rounded-xl transition-all hover:scale-110"
                          style={{
                            backgroundColor: color,
                            border: editColor === color ? '3px solid #1E1E1E' : '2px solid transparent',
                            boxShadow: editColor === color ? '0px 2px 8px rgba(0, 0, 0, 0.2)' : 'none'
                          }}
                        >
                          {editColor === color && (
                            <span className="text-white text-lg">‚úì</span>
                          )}
                        </button>
                      ))}
                      <input
                        type="color"
                        value={editColor}
                        onChange={(e) => setEditColor(e.target.value)}
                        className="w-10 h-10 rounded-lg cursor-pointer border-2 border-gray-200"
                      />
                    </div>
                  </div>
                </div>

                <div className="flex justify-end gap-3 mt-6">
                  <button
                    onClick={handleCancelEdit}
                    className="px-5 py-2.5 rounded-2xl font-medium transition-all hover:scale-105"
                    style={{ backgroundColor: '#F6F6F6', color: 'var(--muted-foreground)' }}
                  >
                    Cancelar
                  </button>
                  <button
                    onClick={handleSaveEdit}
                    className="px-5 py-2.5 rounded-2xl font-medium transition-all hover:scale-105"
                    style={{
                      background: 'linear-gradient(135deg, #C9B7F3 0%, #D6C9F5 100%)',
                      color: 'white'
                    }}
                  >
                    Guardar Cambios
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Delete Confirmation Modal */}
          {deletingArea && (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
              <div
                className="w-full max-w-md p-6 rounded-3xl"
                style={{ backgroundColor: 'var(--card)' }}
              >
                <div className="text-center mb-6">
                  <div
                    className="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"
                    style={{ backgroundColor: '#FFE5E5' }}
                  >
                    <Trash2 className="size-8" style={{ color: '#CC5050' }} />
                  </div>
                  <h3 className="text-xl font-bold mb-2" style={{ color: 'var(--foreground)' }}>
                    Eliminar √Årea
                  </h3>
                  <p style={{ color: 'var(--muted-foreground)' }}>
                    ¬øEst√°s seguro de que quieres eliminar el √°rea <strong>{deletingArea.name}</strong>?
                    Esta acci√≥n no se puede deshacer.
                  </p>
                </div>

                <div className="flex justify-center gap-3">
                  <button
                    onClick={() => setDeletingArea(null)}
                    className="px-5 py-2.5 rounded-2xl font-medium transition-all hover:scale-105"
                    style={{ backgroundColor: '#F6F6F6', color: 'var(--muted-foreground)' }}
                  >
                    Cancelar
                  </button>
                  <button
                    onClick={handleConfirmDelete}
                    className="px-5 py-2.5 rounded-2xl font-medium transition-all hover:scale-105"
                    style={{ backgroundColor: '#CC5050', color: 'white' }}
                  >
                    Eliminar
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* New Area Modal */}
          {showNewAreaForm && (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
              <div
                className="w-full max-w-lg p-6 rounded-3xl"
                style={{ backgroundColor: 'var(--card)' }}
              >
                <div className="flex items-center justify-between mb-6">
                  <h3 className="text-xl font-bold" style={{ color: 'var(--foreground)' }}>
                    Nueva √Årea
                  </h3>
                  <button
                    onClick={() => setShowNewAreaForm(false)}
                    className="p-2 rounded-xl hover:bg-gray-100 transition-all"
                  >
                    <X className="size-5" style={{ color: 'var(--muted-foreground)' }} />
                  </button>
                </div>

                <div className="space-y-4">
                  <div>
                    <label className="text-sm font-medium mb-2 block" style={{ color: 'var(--foreground)' }}>
                      Icono
                    </label>
                    <input
                      type="text"
                      value={newAreaIcon}
                      onChange={(e) => setNewAreaIcon(e.target.value)}
                      className="w-20 p-3 rounded-xl text-2xl text-center"
                      style={{ backgroundColor: '#F6F6F6', border: '2px solid #E6E6E6' }}
                      maxLength={2}
                    />
                  </div>

                  <div>
                    <label className="text-sm font-medium mb-2 block" style={{ color: 'var(--foreground)' }}>
                      Nombre
                    </label>
                    <input
                      type="text"
                      value={newAreaName}
                      onChange={(e) => setNewAreaName(e.target.value)}
                      className="w-full p-3 rounded-xl"
                      style={{ backgroundColor: '#F6F6F6', border: '2px solid #E6E6E6', color: 'var(--foreground)' }}
                      placeholder="Ej: Proyectos Personales"
                    />
                  </div>

                  <div>
                    <label className="text-sm font-medium mb-2 block" style={{ color: 'var(--foreground)' }}>
                      Descripci√≥n
                    </label>
                    <input
                      type="text"
                      value={newAreaDescription}
                      onChange={(e) => setNewAreaDescription(e.target.value)}
                      className="w-full p-3 rounded-xl"
                      style={{ backgroundColor: '#F6F6F6', border: '2px solid #E6E6E6', color: 'var(--foreground)' }}
                      placeholder="Ej: Mis proyectos y side projects"
                    />
                  </div>

                  <div>
                    <label className="text-sm font-medium mb-2 block" style={{ color: 'var(--foreground)' }}>
                      Color
                    </label>
                    <div className="flex items-center gap-2 flex-wrap">
                      {COLOR_PALETTE.map((color) => (
                        <button
                          key={color}
                          onClick={() => setNewAreaColor(color)}
                          className="w-10 h-10 rounded-xl transition-all hover:scale-110"
                          style={{
                            backgroundColor: color,
                            border: newAreaColor === color ? '3px solid #1E1E1E' : '2px solid transparent',
                            boxShadow: newAreaColor === color ? '0px 2px 8px rgba(0, 0, 0, 0.2)' : 'none'
                          }}
                        >
                          {newAreaColor === color && (
                            <span className="text-white text-lg">‚úì</span>
                          )}
                        </button>
                      ))}
                      <input
                        type="color"
                        value={newAreaColor}
                        onChange={(e) => setNewAreaColor(e.target.value)}
                        className="w-10 h-10 rounded-lg cursor-pointer border-2 border-gray-200"
                      />
                    </div>
                  </div>
                </div>

                <div className="flex justify-end gap-3 mt-6">
                  <button
                    onClick={() => setShowNewAreaForm(false)}
                    className="px-5 py-2.5 rounded-2xl font-medium transition-all hover:scale-105"
                    style={{ backgroundColor: '#F6F6F6', color: 'var(--muted-foreground)' }}
                  >
                    Cancelar
                  </button>
                  <button
                    onClick={handleAddNewArea}
                    className="px-5 py-2.5 rounded-2xl font-medium transition-all hover:scale-105"
                    style={{
                      background: 'linear-gradient(135deg, #C9B7F3 0%, #D6C9F5 100%)',
                      color: 'white'
                    }}
                  >
                    Crear √Årea
                  </button>
                </div>
              </div>
            </div>
          )}

          {displayFolders.length > 0 ? (
            displayFolders.map(folder => renderFolder(folder))
          ) : searchQuery.trim() ? (
            /* No results state */
            <div
              className="text-center py-12 rounded-3xl"
              style={{
                backgroundColor: 'var(--card)',
                boxShadow: '0px 4px 14px rgba(0, 0, 0, 0.06)'
              }}
            >
              <div
                className="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4"
                style={{ backgroundColor: '#F6F5F2' }}
              >
                <Search className="size-10" style={{ color: '#9A9A9A' }} />
              </div>
              <h3 className="text-xl font-semibold mb-2" style={{ color: 'var(--foreground)' }}>
                Sin resultados
              </h3>
              <p className="mb-6" style={{ color: 'var(--muted-foreground)' }}>
                No se encontraron notas para "{searchQuery}"
              </p>
              <button
                onClick={() => setSearchQuery('')}
                className="inline-flex items-center gap-2 px-6 py-3 rounded-2xl transition-all hover:scale-105"
                style={{
                  backgroundColor: '#FFD9D9',
                  color: '#222222'
                }}
              >
                Limpiar busqueda
              </button>
            </div>
          ) : (
            /* Empty State */
            <div
              className="text-center py-12 rounded-3xl"
              style={{
                backgroundColor: 'var(--card)',
                boxShadow: '0px 4px 14px rgba(0, 0, 0, 0.06)'
              }}
            >
              <div
                className="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4"
                style={{ backgroundColor: '#E6DEF9' }}
              >
                <FolderOpen className="size-10" style={{ color: '#C9B7F3' }} />
              </div>
              <h3 className="text-xl font-semibold mb-2" style={{ color: 'var(--foreground)' }}>
                Aun no tienes notas
              </h3>
              <p className="mb-6" style={{ color: 'var(--muted-foreground)' }}>
                Crea tu primera nota y sera organizada automaticamente
              </p>
              <Link
                href="/new-query"
                className="inline-flex items-center gap-2 px-6 py-3 text-white rounded-2xl transition-all hover:scale-105"
                style={{
                  background: 'linear-gradient(135deg, #C9B7F3 0%, #D6C9F5 100%)',
                  boxShadow: '0px 4px 14px rgba(201, 183, 243, 0.3)'
                }}
              >
                <Plus className="size-5" />
                Crear primera nota
              </Link>
            </div>
          )}

          {/* Journal Section - Hierarchical structure: Journal > Year > Month > Date */}
          {(
            <div className="mt-8">
              <h2 className="text-lg font-medium mb-4 flex items-center gap-2" style={{ color: 'var(--foreground)' }}>
                <BookHeart className="size-5" style={{ color: '#C9B7F3' }} />
                Journal Personal
              </h2>

              {/* Journal Root Folder */}
              <div className="mb-4">
                <div
                  className="p-6 rounded-3xl cursor-pointer transition-all hover:scale-[1.01] duration-300 relative overflow-hidden"
                  style={{
                    backgroundColor: 'rgba(201, 183, 243, 0.15)',
                    border: '3px solid rgba(201, 183, 243, 0.5)',
                    boxShadow: '0px 4px 14px rgba(0, 0, 0, 0.08)'
                  }}
                  onClick={() => toggleFolder('journal')}
                >
                  <div
                    className="absolute top-0 right-0 w-24 h-24"
                    style={{
                      backgroundColor: 'rgba(201, 183, 243, 0.3)',
                      clipPath: 'polygon(100% 0, 100% 100%, 0 0)'
                    }}
                  />

                  <div className="flex items-start justify-between relative z-10">
                    <div className="flex items-start gap-4 flex-1">
                      <button className="mt-1" style={{ color: '#C9B7F3' }}>
                        {expandedFolders.has('journal') ? (
                          <ChevronDown className="size-6" />
                        ) : (
                          <ChevronRight className="size-6" />
                        )}
                      </button>

                      <div className="flex-1">
                        <div className="flex items-center gap-3 mb-2">
                          <span className="text-3xl">üìì</span>
                          <h3 className="font-bold text-lg" style={{ color: 'var(--foreground)' }}>
                            Journal
                          </h3>
                          <span
                            className="text-xs px-3 py-1.5 rounded-full font-medium"
                            style={{ backgroundColor: 'rgba(255, 255, 255, 0.8)', color: '#646464' }}
                          >
                            {journalEntries.length} {journalEntries.length === 1 ? 'entrada' : 'entradas'}
                          </span>
                        </div>

                        <p className="text-sm mb-3" style={{ color: 'rgba(30, 30, 30, 0.7)' }}>
                          Tu diario personal de reflexiones, gratitud y crecimiento
                        </p>
                      </div>
                    </div>

                    <Link
                      href="/journal"
                      onClick={(e) => e.stopPropagation()}
                      className="px-4 py-2 bg-white rounded-2xl hover:scale-105 transition-all duration-300 flex items-center gap-2 font-medium"
                      style={{ boxShadow: '0px 2px 8px rgba(0, 0, 0, 0.08)', color: '#C9B7F3' }}
                    >
                      <BookHeart className="size-4" />
                      Abrir Journal
                    </Link>
                  </div>
                </div>

                {/* Hierarchical Contents: Year > Month > Entries */}
                {expandedFolders.has('journal') && (
                  <div className="ml-8 mt-2">
                    {Object.entries(journalHierarchy)
                      .sort(([a], [b]) => b.localeCompare(a)) // Sort years descending
                      .map(([year, months]) => (
                        <div key={year} className="mt-2">
                          {/* Year Folder */}
                          <div
                            className="flex items-center gap-2 p-3 rounded-xl cursor-pointer hover:bg-purple-50 transition-all"
                            onClick={() => toggleFolder(`journal-${year}`)}
                          >
                            <button style={{ color: '#C9B7F3' }}>
                              {expandedFolders.has(`journal-${year}`) ? (
                                <ChevronDown className="size-5" />
                              ) : (
                                <ChevronRight className="size-5" />
                              )}
                            </button>
                            <Calendar className="size-4" style={{ color: '#9575CD' }} />
                            <span className="font-medium" style={{ color: 'var(--foreground)' }}>{year}</span>
                          </div>

                          {/* Months within Year */}
                          {expandedFolders.has(`journal-${year}`) && (
                            <div className="ml-8 mt-1">
                              {Object.entries(months)
                                .sort(([a], [b]) => b.localeCompare(a)) // Sort months descending
                                .map(([month, entries]) => (
                                  <div key={`${year}-${month}`} className="mt-1">
                                    {/* Month Folder */}
                                    <div
                                      className="flex items-center gap-2 p-2 rounded-lg cursor-pointer hover:bg-purple-50 transition-all"
                                      onClick={() => toggleFolder(`journal-${year}-${month}`)}
                                    >
                                      <button style={{ color: '#C9B7F3' }}>
                                        {expandedFolders.has(`journal-${year}-${month}`) ? (
                                          <ChevronDown className="size-4" />
                                        ) : (
                                          <ChevronRight className="size-4" />
                                        )}
                                      </button>
                                      <FolderOpen className="size-4" style={{ color: '#C9B7F3' }} />
                                      <span className="text-sm" style={{ color: 'var(--foreground)' }}>{month}</span>
                                      <span className="text-xs px-2 py-0.5 rounded-full" style={{ backgroundColor: 'rgba(201, 183, 243, 0.2)', color: '#9575CD' }}>
                                        {entries.length}
                                      </span>
                                    </div>

                                    {/* Entries within Month */}
                                    {expandedFolders.has(`journal-${year}-${month}`) && (
                                      <div className="ml-8 mt-1 space-y-1">
                                        {entries.map(entry => (
                                          <Link
                                            key={entry.id}
                                            href={`/journal?date=${entry.date}`}
                                            className="flex items-center gap-2 p-2 rounded-lg hover:bg-purple-50 transition-all group"
                                          >
                                            <FileText className="size-4" style={{ color: '#C9B7F3' }} />
                                            <span className="text-sm group-hover:text-purple-600" style={{ color: 'var(--foreground)' }}>
                                              {entry.date}
                                            </span>
                                            {entry.is_complete && (
                                              <span className="text-xs text-green-500">‚úì</span>
                                            )}
                                            {entry.mood && (
                                              <span className="text-xs">{['üò¢', 'üòï', 'üòê', 'üôÇ', 'üòÑ'][entry.mood - 1]}</span>
                                            )}
                                          </Link>
                                        ))}
                                      </div>
                                    )}
                                  </div>
                                ))}
                            </div>
                          )}
                        </div>
                      ))}
                  </div>
                )}
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  )
}
