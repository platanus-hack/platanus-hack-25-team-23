"use client"

import { useState, useEffect, useCallback, useMemo } from 'react'
import { useKnowledge } from "@/lib/store/knowledge-context"
import { createClient } from "@/lib/supabase/client"
import {
  FolderOpen,
  FileText,
  Download,
  Sparkles,
  ChevronRight,
  ChevronDown,
  Brain,
  Clock,
  Zap,
  Plus
} from "lucide-react"
import Link from 'next/link'
import { toast } from 'sonner'

interface LibraryNote {
  id: string
  title: string
  slug: string
  content: string
  status: 'new' | 'read' | 'understood'
  area: string
  areaColor: string
  createdAt: string
  lastModified: string
  wordCount: number
  conceptsCount: number
}

interface Folder {
  id: string
  name: string
  description: string
  color: string
  icon: string
  notes: LibraryNote[]
  subfolders?: Folder[]
  autoGenerated: boolean
  lastOrganized: Date
}

// Area definitions with colors and icons
const AREA_CONFIG: Record<string, { color: string; icon: string; description: string }> = {
  'Desarrollo Profesional': { color: '#3b82f6', icon: 'üíº', description: 'Carrera, habilidades t√©cnicas y crecimiento laboral' },
  'Programacion': { color: '#3b82f6', icon: 'üíª', description: 'C√≥digo, algoritmos y desarrollo de software' },
  'Matematicas': { color: '#8b5cf6', icon: 'üßÆ', description: '√Ålgebra, c√°lculo, estad√≠stica y matem√°ticas aplicadas' },
  'Ciencias': { color: '#22c55e', icon: 'üî¨', description: 'F√≠sica, qu√≠mica, biolog√≠a y ciencias naturales' },
  'Salud y Bienestar': { color: '#22c55e', icon: 'üèÉ', description: 'Ejercicio, nutrici√≥n, salud mental y f√≠sica' },
  'Finanzas Personales': { color: '#eab308', icon: 'üí∞', description: 'Presupuesto, inversiones, ahorro y libertad financiera' },
  'Historia': { color: '#f97316', icon: 'üìú', description: 'Historia, geograf√≠a y ciencias sociales' },
  'Idiomas': { color: '#ec4899', icon: 'üó£Ô∏è', description: 'Ingl√©s, espa√±ol y aprendizaje de idiomas' },
  'Arte': { color: '#8b5cf6', icon: 'üé®', description: 'Arte, m√∫sica, dise√±o y expresi√≥n creativa' },
  'Economia': { color: '#eab308', icon: 'üìä', description: 'Econom√≠a, finanzas y negocios' },
  'Humanidades': { color: '#ec4899', icon: 'üìö', description: 'Filosof√≠a, psicolog√≠a y ciencias humanas' },
  'Educacion Continua': { color: '#f97316', icon: 'üìö', description: 'Cursos, lectura, aprendizaje y desarrollo intelectual' },
  'Crecimiento Personal': { color: '#9333ea', icon: 'üå±', description: 'H√°bitos, mindfulness y autoconocimiento' },
  'General': { color: '#C9B7F3', icon: 'üìù', description: 'Notas generales y temas variados' },
}

// Helper to categorize notes by keywords
function detectArea(title: string, content: string): string {
  const text = `${title} ${content}`.toLowerCase()

  if (text.includes('matemat') || text.includes('algebra') || text.includes('calcul') || text.includes('geometr') || text.includes('ecuacion')) {
    return 'Matematicas'
  }
  if (text.includes('program') || text.includes('codigo') || text.includes('software') || text.includes('algoritm') || text.includes('javascript') || text.includes('python') || text.includes('react')) {
    return 'Programacion'
  }
  if (text.includes('fisica') || text.includes('quimica') || text.includes('biolog') || text.includes('ciencia')) {
    return 'Ciencias'
  }
  if (text.includes('histor') || text.includes('geograf') || text.includes('social')) {
    return 'Historia'
  }
  if (text.includes('idioma') || text.includes('ingles') || text.includes('espa√±ol') || text.includes('lenguaje') || text.includes('grammar')) {
    return 'Idiomas'
  }
  if (text.includes('arte') || text.includes('musica') || text.includes('dibujo') || text.includes('dise√±o')) {
    return 'Arte'
  }
  if (text.includes('econom') || text.includes('finanz') || text.includes('negocio') || text.includes('empresa') || text.includes('inversion')) {
    return 'Finanzas Personales'
  }
  if (text.includes('filosof') || text.includes('psicolog') || text.includes('sociolog')) {
    return 'Humanidades'
  }
  if (text.includes('salud') || text.includes('ejercicio') || text.includes('nutricion') || text.includes('fitness')) {
    return 'Salud y Bienestar'
  }
  if (text.includes('habito') || text.includes('productividad') || text.includes('meditacion') || text.includes('mindfulness')) {
    return 'Crecimiento Personal'
  }

  return 'General'
}

function getAreaConfig(areaName: string) {
  return AREA_CONFIG[areaName] || AREA_CONFIG['General']
}

export default function LibraryPage() {
  const { notes: contextNotes, session } = useKnowledge()
  const [libraryNotes, setLibraryNotes] = useState<LibraryNote[]>([])
  const [loading, setLoading] = useState(true)
  const [isOrganizing, setIsOrganizing] = useState(false)
  const [lastOrganized, setLastOrganized] = useState(new Date())
  const [expandedFolders, setExpandedFolders] = useState<Set<string>>(new Set())

  const loadLibraryData = useCallback(async () => {
    setLoading(true)

    // If no session, use notes from context
    if (!session?.user) {
      const notesFromContext: LibraryNote[] = contextNotes.map(note => {
        const area = detectArea(note.title, note.content)
        return {
          id: note.id || note.slug,
          title: note.title,
          slug: note.slug,
          content: note.content,
          status: note.status,
          area,
          areaColor: getAreaConfig(area).color,
          createdAt: new Date().toISOString(),
          lastModified: new Date().toISOString(),
          wordCount: note.content.split(/\s+/).length,
          conceptsCount: Math.floor(note.content.split(/\s+/).length / 50) + 1
        }
      })
      setLibraryNotes(notesFromContext)
      // Expand first folder by default
      if (notesFromContext.length > 0) {
        const firstArea = detectArea(notesFromContext[0].title, notesFromContext[0].content)
        setExpandedFolders(new Set([firstArea.toLowerCase().replace(/\s+/g, '-')]))
      }
      setLoading(false)
      return
    }

    const supabase = createClient()

    // Load notes from the notes table
    const { data: notesData, error } = await supabase
      .from('notes')
      .select('*')
      .eq('user_id', session.user.id)
      .order('created_at', { ascending: false })

    if (error) {
      console.error('Error loading notes:', error)
      toast.error('Error al cargar las notas')
      setLoading(false)
      return
    }

    if (notesData) {
      const loadedNotes: LibraryNote[] = notesData.map(n => {
        const area = detectArea(n.title, n.content || '')
        return {
          id: n.id,
          title: n.title,
          slug: n.slug,
          content: n.content || '',
          status: (n.status || 'new') as 'new' | 'read' | 'understood',
          area,
          areaColor: getAreaConfig(area).color,
          createdAt: n.created_at,
          lastModified: n.updated_at || n.created_at,
          wordCount: (n.content || '').split(/\s+/).length,
          conceptsCount: Math.floor((n.content || '').split(/\s+/).length / 50) + 1
        }
      })
      setLibraryNotes(loadedNotes)
      // Expand first folder by default
      if (loadedNotes.length > 0) {
        setExpandedFolders(new Set([loadedNotes[0].area.toLowerCase().replace(/\s+/g, '-')]))
      }
    }

    setLoading(false)
  }, [session, contextNotes])

  useEffect(() => {
    loadLibraryData()
  }, [loadLibraryData])

  // Calculate stats
  const stats = useMemo(() => {
    const total = libraryNotes.length
    const understood = libraryNotes.filter(n => n.status === 'understood').length
    const inProgress = libraryNotes.filter(n => n.status === 'read').length
    const pending = libraryNotes.filter(n => n.status === 'new').length
    return { total, understood, inProgress, pending }
  }, [libraryNotes])

  // Create folder structure
  const folders: Folder[] = useMemo(() => {
    const grouped = libraryNotes.reduce((acc, note) => {
      if (!acc[note.area]) {
        acc[note.area] = []
      }
      acc[note.area].push(note)
      return acc
    }, {} as Record<string, LibraryNote[]>)

    return Object.entries(grouped).map(([areaName, notes]) => {
      const config = getAreaConfig(areaName)
      return {
        id: areaName.toLowerCase().replace(/\s+/g, '-'),
        name: areaName,
        description: config.description,
        color: config.color,
        icon: config.icon,
        notes,
        autoGenerated: true,
        lastOrganized
      }
    })
  }, [libraryNotes, lastOrganized])

  // Toggle folder expansion
  const toggleFolder = (folderId: string) => {
    setExpandedFolders(prev => {
      const newSet = new Set(prev)
      if (newSet.has(folderId)) {
        newSet.delete(folderId)
      } else {
        newSet.add(folderId)
      }
      return newSet
    })
  }

  // Reorganize handler
  const handleReorganize = useCallback(async () => {
    setIsOrganizing(true)
    // Simulate reorganization
    await new Promise(resolve => setTimeout(resolve, 2000))

    // Re-detect areas for all notes
    const reorganized = libraryNotes.map(note => {
      const area = detectArea(note.title, note.content)
      return {
        ...note,
        area,
        areaColor: getAreaConfig(area).color
      }
    })

    setLibraryNotes(reorganized)
    setLastOrganized(new Date())
    setIsOrganizing(false)
    toast.success(`Reorganizado! ${reorganized.length} notas en ${new Set(reorganized.map(n => n.area)).size} carpetas`)
  }, [libraryNotes])

  // Export folder to Markdown
  const exportFolderToMarkdown = useCallback((folder: Folder) => {
    let markdown = `# ${folder.icon} ${folder.name}\n\n`
    markdown += `> ${folder.description}\n\n`
    markdown += `**√öltima organizaci√≥n:** ${folder.lastOrganized.toLocaleString('es')}\n\n`
    markdown += `---\n\n`

    folder.notes.forEach(note => {
      markdown += `## ${note.title}\n\n`
      markdown += `- **Estado:** ${getStatusLabel(note.status)}\n`
      markdown += `- **Creado:** ${new Date(note.createdAt).toLocaleDateString('es')}\n`
      markdown += `- **Palabras:** ${note.wordCount}\n`
      markdown += `- **Conceptos:** ${note.conceptsCount}\n\n`
      markdown += `${note.content}\n\n`
      markdown += `---\n\n`
    })

    const blob = new Blob([markdown], { type: 'text/markdown' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `${folder.name.toLowerCase().replace(/\s+/g, '-')}.md`
    document.body.appendChild(a)
    a.click()
    document.body.removeChild(a)
    URL.revokeObjectURL(url)

    toast.success('Exportado correctamente')
  }, [])

  const getStatusLabel = (status: string) => {
    switch (status) {
      case 'understood': return '‚úÖ Entendido'
      case 'read': return 'üîÑ En progreso'
      case 'new': return '‚è≥ Pendiente'
      default: return status
    }
  }

  const getStatusStyle = (status: string) => {
    switch (status) {
      case 'understood':
        return { background: 'linear-gradient(135deg, #A3E4B6 0%, #B9E2B1 100%)', color: '#2F8F4F' }
      case 'read':
        return { background: 'linear-gradient(135deg, #FFE9A9 0%, #FFF4D4 100%)', color: '#B89C3C' }
      case 'new':
        return { background: 'linear-gradient(135deg, #FFB1B1 0%, #FFCBCB 100%)', color: '#CC5050' }
      default:
        return { background: '#F6F6F6', color: '#646464' }
    }
  }

  const getTimeSince = (dateString: string) => {
    const hours = Math.floor((Date.now() - new Date(dateString).getTime()) / (1000 * 60 * 60))
    if (hours < 1) return 'hace menos de 1h'
    if (hours < 24) return `hace ${hours}h`
    const days = Math.floor(hours / 24)
    return `hace ${days}d`
  }

  // Render folder component
  const renderFolder = (folder: Folder) => {
    const isExpanded = expandedFolders.has(folder.id)
    const totalNotes = folder.notes.length

    return (
      <div key={folder.id} className="mb-4">
        {/* Folder Header */}
        <div
          className="p-6 rounded-3xl cursor-pointer transition-all hover:scale-[1.01] duration-300 relative overflow-hidden"
          style={{
            backgroundColor: `${folder.color}20`,
            border: `3px solid ${folder.color}80`,
            boxShadow: '0px 4px 14px rgba(0, 0, 0, 0.08)'
          }}
          onClick={() => toggleFolder(folder.id)}
        >
          {/* Decorative corner accent */}
          <div
            className="absolute top-0 right-0 w-24 h-24"
            style={{
              backgroundColor: `${folder.color}40`,
              clipPath: 'polygon(100% 0, 100% 100%, 0 0)'
            }}
          />
          <div
            className="absolute bottom-0 left-0 w-16 h-16 rounded-full opacity-50"
            style={{ backgroundColor: `${folder.color}20` }}
          />

          <div className="flex items-start justify-between relative z-10">
            <div className="flex items-start gap-4 flex-1">
              <button className="mt-1" style={{ color: folder.color }}>
                {isExpanded ? (
                  <ChevronDown className="size-6" />
                ) : (
                  <ChevronRight className="size-6" />
                )}
              </button>

              <div className="flex-1">
                <div className="flex items-center gap-3 mb-2">
                  <span className="text-3xl">{folder.icon}</span>
                  <h3 className="font-bold text-lg" style={{ color: 'var(--foreground)' }}>
                    {folder.name}
                  </h3>
                  <span
                    className="text-xs px-3 py-1.5 rounded-full font-medium"
                    style={{ backgroundColor: 'rgba(255, 255, 255, 0.8)', color: '#646464' }}
                  >
                    {totalNotes} {totalNotes === 1 ? 'nota' : 'notas'}
                  </span>
                  {folder.autoGenerated && (
                    <span
                      className="text-xs px-3 py-1.5 rounded-full font-medium flex items-center gap-1.5"
                      style={{
                        background: 'linear-gradient(135deg, #C9B7F3 0%, #D6C9F5 100%)',
                        color: 'white'
                      }}
                    >
                      <Sparkles className="size-3" />
                      Auto-organizado
                    </span>
                  )}
                </div>

                <p className="text-sm mb-3" style={{ color: 'rgba(30, 30, 30, 0.7)' }}>
                  {folder.description}
                </p>

                <div className="flex items-center gap-2 text-xs" style={{ color: 'rgba(30, 30, 30, 0.6)' }}>
                  <Clock className="size-3.5" />
                  <span>√öltima organizaci√≥n: {folder.lastOrganized.toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' })}</span>
                </div>
              </div>
            </div>

            <button
              onClick={(e) => {
                e.stopPropagation()
                exportFolderToMarkdown(folder)
              }}
              className="px-4 py-2 bg-white rounded-2xl hover:scale-105 transition-all duration-300 flex items-center gap-2 font-medium"
              style={{ boxShadow: '0px 2px 8px rgba(0, 0, 0, 0.08)', color: '#646464' }}
            >
              <Download className="size-4" />
              Exportar MD
            </button>
          </div>
        </div>

        {/* Folder Contents */}
        {isExpanded && (
          <div className="ml-10 mt-3 space-y-3">
            {folder.notes.map(note => (
              <Link
                key={note.id}
                href={`/study?topic=${encodeURIComponent(note.title)}`}
                className="block p-5 rounded-2xl hover:scale-[1.01] transition-all cursor-pointer"
                style={{
                  boxShadow: '0px 2px 8px rgba(0, 0, 0, 0.06)',
                  border: '2px solid transparent'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.border = '2px solid #C9B7F3'
                  e.currentTarget.style.boxShadow = '0px 4px 14px rgba(201, 183, 243, 0.2)'
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.border = '2px solid transparent'
                  e.currentTarget.style.boxShadow = '0px 2px 8px rgba(0, 0, 0, 0.06)'
                }}
              >
                <div className="flex items-start justify-between">
                  <div className="flex items-start gap-3 flex-1">
                    <div
                      className="p-2 rounded-xl"
                      style={{ backgroundColor: 'rgba(201, 183, 243, 0.15)' }}
                    >
                      <FileText className="size-5" style={{ color: '#9575CD' }} />
                    </div>
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-2">
                        <h4 className="font-semibold" style={{ color: 'var(--foreground)' }}>
                          {note.title}
                        </h4>
                        <span
                          className="text-xs px-3 py-1 rounded-full font-medium"
                          style={getStatusStyle(note.status)}
                        >
                          {getStatusLabel(note.status)}
                        </span>
                      </div>

                      <div className="flex items-center gap-4 text-xs" style={{ color: 'var(--muted-foreground)' }}>
                        <span className="flex items-center gap-1">
                          üìù {note.wordCount} palabras
                        </span>
                        <span className="flex items-center gap-1">
                          üß© {note.conceptsCount} conceptos
                        </span>
                        <span className="flex items-center gap-1">
                          üïí Modificado {getTimeSince(note.lastModified)}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </Link>
            ))}
          </div>
        )}
      </div>
    )
  }

  if (loading) {
    return (
      <div className="flex-1 flex items-center justify-center transition-colors duration-300" style={{ backgroundColor: 'var(--background)' }}>
        <div className="text-center">
          <div className="w-12 h-12 border-4 border-purple-300 rounded-full animate-spin mx-auto mb-4" style={{ borderTopColor: '#C9B7F3' }} />
          <p style={{ color: 'var(--muted-foreground)' }}>Cargando biblioteca...</p>
        </div>
      </div>
    )
  }

  return (
    <div className="flex-1 overflow-y-auto transition-colors duration-300" style={{ backgroundColor: 'var(--background)' }}>
      <div className="max-w-6xl mx-auto px-8 py-8">
        {/* Header */}
        <div className="mb-8">
          <div className="flex items-center justify-between mb-6">
            <div>
              <h1 className="text-4xl font-bold mb-2 flex items-center gap-3" style={{ color: 'var(--foreground)' }}>
                <FolderOpen className="size-10" style={{ color: '#C9B7F3' }} />
                Biblioteca Inteligente
              </h1>
              <p className="text-lg" style={{ color: 'var(--muted-foreground)' }}>
                Tus notas organizadas autom√°ticamente por la IA seg√∫n temas y relaciones
              </p>
            </div>

            <div className="flex items-center gap-3">
              <button
                onClick={handleReorganize}
                disabled={isOrganizing}
                className="px-6 py-3 text-white rounded-3xl transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 hover:scale-105 duration-300"
                style={{
                  background: 'linear-gradient(135deg, #C9B7F3 0%, #D6C9F5 100%)',
                  boxShadow: '0px 4px 14px rgba(201, 183, 243, 0.3)'
                }}
              >
                {isOrganizing ? (
                  <>
                    <div
                      className="w-5 h-5 border-2 border-white rounded-full animate-spin"
                      style={{ borderTopColor: 'transparent' }}
                    />
                    Reorganizando...
                  </>
                ) : (
                  <>
                    <Brain className="size-5" />
                    Reorganizar Ahora
                  </>
                )}
              </button>
            </div>
          </div>

          {/* Stats */}
          <div className="grid grid-cols-4 gap-5 mb-6">
            <div
              className="p-5 rounded-3xl transition-all hover:scale-105 duration-300"
              style={{ backgroundColor: 'var(--card)', boxShadow: '0px 4px 14px rgba(0, 0, 0, 0.06)' }}
            >
              <div className="text-3xl font-bold mb-1" style={{ color: 'var(--muted-foreground)' }}>
                {stats.total}
              </div>
              <div className="text-sm" style={{ color: 'var(--muted-foreground)' }}>Notas totales</div>
            </div>
            <div
              className="p-5 rounded-3xl transition-all hover:scale-105 duration-300"
              style={{
                background: 'linear-gradient(135deg, #A3E4B6 0%, #B9E2B1 100%)',
                boxShadow: '0px 4px 14px rgba(163, 228, 182, 0.3)'
              }}
            >
              <div className="text-3xl font-bold mb-1" style={{ color: '#2F8F4F' }}>
                {stats.understood}
              </div>
              <div className="text-sm" style={{ color: '#2F8F4F' }}>Entendidas</div>
            </div>
            <div
              className="p-5 rounded-3xl transition-all hover:scale-105 duration-300"
              style={{
                background: 'linear-gradient(135deg, #FFE9A9 0%, #FFF4D4 100%)',
                boxShadow: '0px 4px 14px rgba(255, 233, 169, 0.3)'
              }}
            >
              <div className="text-3xl font-bold mb-1" style={{ color: '#B89C3C' }}>
                {stats.inProgress}
              </div>
              <div className="text-sm" style={{ color: '#B89C3C' }}>En progreso</div>
            </div>
            <div
              className="p-5 rounded-3xl transition-all hover:scale-105 duration-300"
              style={{
                background: 'linear-gradient(135deg, #FFB1B1 0%, #FFCBCB 100%)',
                boxShadow: '0px 4px 14px rgba(255, 177, 177, 0.3)'
              }}
            >
              <div className="text-3xl font-bold mb-1" style={{ color: '#CC5050' }}>
                {stats.pending}
              </div>
              <div className="text-sm" style={{ color: '#CC5050' }}>Pendientes</div>
            </div>
          </div>

          {/* Info Banner */}
          <div
            className="p-6 rounded-3xl flex items-start gap-4"
            style={{
              background: 'linear-gradient(135deg, #D6C9F5 0%, #E6DEF9 100%)',
              boxShadow: '0px 4px 14px rgba(214, 201, 245, 0.3)'
            }}
          >
            <div
              className="p-3 rounded-2xl backdrop-blur-sm"
              style={{ backgroundColor: 'rgba(255, 255, 255, 0.5)' }}
            >
              <Sparkles className="size-6" style={{ color: '#9575CD' }} />
            </div>
            <div className="flex-1">
              <h3 className="font-semibold text-lg mb-2" style={{ color: 'var(--foreground)' }}>
                Organizaci√≥n Autom√°tica Activada
              </h3>
              <p className="text-sm" style={{ color: 'rgba(30, 30, 30, 0.7)' }}>
                Nodi reorganiza tus notas cada d√≠a a las 23:00. La √∫ltima reorganizaci√≥n fue hace{' '}
                {Math.floor((Date.now() - lastOrganized.getTime()) / (1000 * 60 * 60))} horas.
                Puedes forzar una reorganizaci√≥n manual haciendo click en el bot√≥n de arriba.
              </p>
            </div>
            <div
              className="p-2 rounded-xl"
              style={{ backgroundColor: 'rgba(255, 255, 255, 0.3)' }}
            >
              <Zap className="size-5" style={{ color: '#9575CD' }} />
            </div>
          </div>
        </div>

        {/* Folders */}
        <div className="space-y-4">
          <h2 className="text-lg font-medium mb-4" style={{ color: 'var(--foreground)' }}>
            Carpetas organizadas por la IA
          </h2>

          {folders.length > 0 ? (
            folders.map(folder => renderFolder(folder))
          ) : (
            /* Empty State */
            <div
              className="text-center py-12 rounded-3xl"
              style={{
                backgroundColor: 'var(--card)',
                boxShadow: '0px 4px 14px rgba(0, 0, 0, 0.06)'
              }}
            >
              <div
                className="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4"
                style={{ backgroundColor: '#E6DEF9' }}
              >
                <FolderOpen className="size-10" style={{ color: '#C9B7F3' }} />
              </div>
              <h3 className="text-xl font-semibold mb-2" style={{ color: 'var(--foreground)' }}>
                A√∫n no tienes notas
              </h3>
              <p className="mb-6" style={{ color: 'var(--muted-foreground)' }}>
                Crea tu primera nota y Nodi la organizar√° autom√°ticamente
              </p>
              <Link
                href="/new-query"
                className="inline-flex items-center gap-2 px-6 py-3 text-white rounded-2xl transition-all hover:scale-105"
                style={{
                  background: 'linear-gradient(135deg, #C9B7F3 0%, #D6C9F5 100%)',
                  boxShadow: '0px 4px 14px rgba(201, 183, 243, 0.3)'
                }}
              >
                <Plus className="size-5" />
                Crear primera nota
              </Link>
            </div>
          )}
        </div>
      </div>
    </div>
  )
}
